"""
Vulnerability Agent for IRB Review

Focuses on protection of vulnerable populations and special considerations.
"""

from typing import Dict, Any
from .base import BaseAgent


class VulnerabilityAgent(BaseAgent):
    """Agent specializing in vulnerable populations and special protections."""
    
    def get_focus_area(self) -> str:
        return "vulnerable populations and special protections required"
    
    def _extract_relevant_criteria(self, all_criteria: Dict) -> Dict:
        """Extract vulnerability-specific criteria."""
        return {
            "focus": "Vulnerable Populations",
            "vulnerable_groups": [
                "Children and minors",
                "Prisoners",
                "Pregnant women",
                "Persons with diminished autonomy or capacity",
                "Educationally or economically disadvantaged",
                "Employees or students (power dynamics)",
                "Persons with mental or cognitive disabilities",
                "Terminally ill individuals",
                "Non-English speakers",
                "Undocumented individuals"
            ],
            "special_protections": [
                "Additional consent requirements (parental consent, assent)",
                "Simplified or translated materials",
                "Enhanced privacy protections",
                "Additional monitoring or oversight",
                "Exclusion criteria to protect vulnerable groups",
                "Protection from coercion or undue influence",
                "Appropriate benefits and compensation",
                "Capacity assessment procedures"
            ],
            "assessment_questions": [
                "Does the study involve vulnerable populations?",
                "Are adequate protections in place?",
                "Is there potential for coercion (students, employees)?",
                "Are inclusion/exclusion criteria appropriate?",
                "Are consent procedures adequate for the population?",
                "Is there appropriate legal representation?",
                "Are benefits proportional and appropriate?",
                "Is there enhanced monitoring planned?"
            ],
            "red_flags": [
                "Vulnerable populations without additional protections",
                "Power dynamics creating coercion risk",
                "Inadequate consent procedures for population",
                "Exploitation concerns",
                "Disproportionate risks for vulnerable groups",
                "Inadequate capacity assessment",
                "Lack of translated materials when needed",
                "Inappropriate inclusion of protected groups"
            ]
        }
    
    def _get_default_criteria(self) -> Dict:
        """Default vulnerability criteria."""
        return self._extract_relevant_criteria({})
    
    def build_prompt(self, materials: Dict[str, Any]) -> str:
        """Build vulnerability-focused prompt."""
        base_prompt = super().build_prompt(materials)
        
        vulnerability_specific = """

SPECIFIC VULNERABILITY FOCUS AREAS:

1. **Population Identification**:
   - Does the study involve any vulnerable populations?
   - Are there power dynamics (student-faculty, employee-employer)?
   - Are there capacity or autonomy concerns?
   - Are participants from disadvantaged groups?

2. **Special Protections**:
   - For children: Is there parental consent AND child assent?
   - For prisoners: Are additional DOJ requirements met?
   - For cognitively impaired: Is capacity assessed?
   - For non-English speakers: Are materials translated?
   - For employees/students: Are coercion protections adequate?

3. **Informed Consent Adequacy**:
   - Is consent process appropriate for population?
   - Is language level appropriate?
   - Are comprehension checks included?
   - Is there a legally authorized representative if needed?
   - Is voluntary participation clearly established?

4. **Risk-Benefit Assessment**:
   - Are risks disproportionate for vulnerable groups?
   - Are benefits accessible to participants?
   - Is compensation appropriate (not coercive)?
   - Are there exploitation concerns?

5. **Inclusion/Exclusion**:
   - Is exclusion of vulnerable groups justified?
   - Is inclusion of vulnerable groups justified and necessary?
   - Are protections proportional to vulnerabilities?

Carefully evaluate whether vulnerable populations are appropriately protected or 
inappropriately excluded. Flag any power dynamics, coercion risks, or inadequate 
protections for vulnerable groups.
"""
        
        return base_prompt + vulnerability_specific








